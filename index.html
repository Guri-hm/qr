<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap JS for dismissible alerts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        /* --- UIèª¿æ•´ --- */
        .row.align-items-end .form-label {
            font-weight: 500;
        }

        .row.align-items-end .form-select {
            min-width: 120px;
        }

        .row.align-items-end .btn {
            min-width: 110px;
        }

        @media (max-width: 767px) {
            .row.align-items-end .btn {
                width: 100%;
            }

            .row.align-items-end .d-flex {
                flex-direction: column;
                gap: 8px !important;
            }
        }

        /* --- æ—¢å­˜ --- */
        .video-wrap {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            /* 16:9 */
            background: #000;
            border-radius: .5rem;
            overflow: hidden;
        }

        video,
        canvas#overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #results {
            max-height: 40vh;
            overflow: auto;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-4">
        <h1 class="h4 mb-3">QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼</h1>

        <div class="row g-3">
            <div class="col-12 col-lg-8">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-end mb-3 g-2">
                            <div class="col-12 col-md-6">
                                <label class="form-label mb-1">ã‚«ãƒ¡ãƒ©é¸æŠ</label>
                                <select id="cameraSelect" class="form-select form-select-sm w-100"></select>
                            </div>
                            <div class="col-12 col-md-6 text-md-end mt-2 mt-md-0">
                                <div class="d-flex justify-content-md-end gap-2">
                                    <button id="switchBtn" class="btn btn-outline-primary btn-sm">èƒŒé¢å„ªå…ˆã§å†èµ·å‹•</button>
                                    <button id="toggleBtn" class="btn btn-danger btn-sm">åœæ­¢</button>
                                </div>
                            </div>
                        </div>

                        <div class="video-wrap mb-2">
                            <video id="video" autoplay playsinline muted></video>
                            <canvas id="overlay"></canvas>
                        </div>

                        <div class="small text-muted">
                            â€» ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚<br>
                            <span id="protocolWarning" class="text-warning" style="display:none;">
                                âš ï¸ HTTPSã§ã¯ãªã„ãŸã‚ã€ä¸€éƒ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚«ãƒ¡ãƒ©ãŒå‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-4">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title">èª­ã¿å–ã‚Šçµæœ</h6>
                        <div id="latest" class="mb-2 text-truncate" style="min-height:2em;">èª­ã¿å–ã‚Šå¾…ã¡...</div>
                        <div class="mb-2">
                            <button id="clearBtn" class="btn btn-outline-secondary btn-sm">ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢</button>
                        </div>
                        <div id="results" class="list-group list-group-flush overflow-auto mt-2"></div>
                        <div class="mt-auto pt-2 small text-muted">èª­ã¿å–ã‚‹ãŸã³ã«ä¸‹ã®ãƒªã‚¹ãƒˆã¸è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jsQR (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const overlayCtx = overlay.getContext('2d');
        const cameraSelect = document.getElementById('cameraSelect');
        const switchBtn = document.getElementById('switchBtn');
        const toggleBtn = document.getElementById('toggleBtn');
        const resultsEl = document.getElementById('results');
        const latestEl = document.getElementById('latest');
        const clearBtn = document.getElementById('clearBtn');

        let stream = null;
        let devices = [];
        let currentDeviceId = null;
        let scanning = false; // start as stopped to avoid auto permission prompts
        let rafId = null;
        let lastScanned = { data: null, time: 0 };

        const captureCanvas = document.createElement('canvas');
        const captureCtx = captureCanvas.getContext('2d');

        async function enumerateCameras() {
            try {
                const devs = await navigator.mediaDevices.enumerateDevices();
                devices = devs.filter(d => d.kind === 'videoinput');
                cameraSelect.innerHTML = '';
                devices.forEach((d, idx) => {
                    const opt = document.createElement('option');
                    opt.value = d.deviceId;
                    opt.text = d.label || `ã‚«ãƒ¡ãƒ© ${idx + 1}`;
                    cameraSelect.appendChild(opt);
                });
            } catch (e) {
                console.error('enumerateDevices error', e);
            }
        }

        async function startCamera(preferEnvironment = true, deviceId = null) {
            stopCamera();

            // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ã®Chrome/Edge/Firefox/Safariã‚’ãŠä½¿ã„ãã ã•ã„ã€‚');
                return;
            }

            try {
                let constraints = {
                    audio: false,
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                if (deviceId) {
                    constraints.video.deviceId = { exact: deviceId };
                } else if (preferEnvironment) {
                    constraints.video.facingMode = { ideal: 'environment' };
                } else {
                    constraints.video.facingMode = { ideal: 'user' };
                }

                stream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (e) {
                console.error('First attempt failed:', e);

                // ã‚ˆã‚Šç·©ã„åˆ¶ç´„ã§å†è©¦è¡Œ
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        },
                        audio: false
                    });
                } catch (err) {
                    console.error('Second attempt failed:', err);
                    handleCameraError(err);
                    return;
                }
            }

            video.srcObject = stream;
            await video.play();

            const track = stream.getVideoTracks()[0];
            const settings = track.getSettings();
            currentDeviceId = settings.deviceId || null;

            resizeCanvases();
            await enumerateCameras();
            if (currentDeviceId) cameraSelect.value = currentDeviceId;

            scanning = true;
            toggleBtn.textContent = 'åœæ­¢';
            tick();
        }

        function stopCamera() {
            scanning = false;
            if (rafId) cancelAnimationFrame(rafId);
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
            toggleBtn.textContent = 'èµ·å‹•';
        }

        function resizeCanvases() {
            const rect = video.getBoundingClientRect();
            overlay.width = rect.width;
            overlay.height = rect.height;

            const track = stream && stream.getVideoTracks()[0];
            const settings = track ? track.getSettings() : {};
            const w = settings.width || video.videoWidth || 640;
            const h = settings.height || video.videoHeight || 480;
            captureCanvas.width = w;
            captureCanvas.height = h;
        }

        function drawLine(ctx, begin, end, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(begin.x, begin.y);
            ctx.lineTo(end.x, end.y);
            ctx.stroke();
        }

        function mapPointToOverlay(point, videoW, videoH) {
            const overlayW = overlay.width;
            const overlayH = overlay.height;
            return {
                x: point.x * (overlayW / videoW),
                y: point.y * (overlayH / videoH)
            };
        }

        function tick() {
            if (!scanning || !stream) return;
            if (video.readyState !== video.HAVE_ENOUGH_DATA) {
                rafId = requestAnimationFrame(tick);
                return;
            }

            resizeCanvases();

            const videoW = captureCanvas.width;
            const videoH = captureCanvas.height;
            captureCtx.drawImage(video, 0, 0, videoW, videoH);

            const imageData = captureCtx.getImageData(0, 0, videoW, videoH);

            const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });

            overlayCtx.clearRect(0, 0, overlay.width, overlay.height);

            if (code) {
                const p0 = mapPointToOverlay(code.location.topLeftCorner, videoW, videoH);
                const p1 = mapPointToOverlay(code.location.topRightCorner, videoW, videoH);
                const p2 = mapPointToOverlay(code.location.bottomRightCorner, videoW, videoH);
                const p3 = mapPointToOverlay(code.location.bottomLeftCorner, videoW, videoH);

                drawLine(overlayCtx, p0, p1, '#00FF00');
                drawLine(overlayCtx, p1, p2, '#00FF00');
                drawLine(overlayCtx, p2, p3, '#00FF00');
                drawLine(overlayCtx, p3, p0, '#00FF00');

                const now = Date.now();
                const data = code.data ? String(code.data).trim() : '';

                if (data && (data !== lastScanned.data || (now - lastScanned.time) > 1500)) {
                    lastScanned = { data, time: now };
                    addResult(data);
                }

                latestEl.textContent = data || 'èª­ã¿å–ã‚Š: ç©º';
            } else {
                latestEl.textContent = 'èª­ã¿å–ã‚Šå¾…ã¡...';
            }

            rafId = requestAnimationFrame(tick);
        }

        let lastCheckedBtn = null;


        function addResult(data) {
            const item = document.createElement('a');
            item.className = 'list-group-item list-group-item-action d-flex align-items-center';
            item.target = '_blank';
            const isUrl = /^https?:\/\//i.test(data) || /^www\./i.test(data);
            item.href = isUrl ? (data.startsWith('http') ? data : 'http://' + data) : '#';
            item.rel = 'noopener noreferrer';
            item.title = data; // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º

            const time = new Date().toLocaleTimeString();
            const icon = isUrl ? '<span style="color:#0d6efd;">ğŸ”—</span> ' : '';

            item.innerHTML = `
        <div class="d-flex w-100 justify-content-between align-items-center">
            <div class="text-truncate flex-grow-1">${icon}${escapeHtml(data)}</div>
            <div class="d-flex align-items-center">
                <small class="text-muted">${time}</small>
                <span class="ms-2 clipboard-btn" style="cursor:pointer;" title="ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼">
                    <i class="bi bi-clipboard"></i>
                </span>
            </div>
        </div>
    `;

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
            const btn = item.querySelector('.clipboard-btn');
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                navigator.clipboard.writeText(data).then(() => {
                    // ä»¥å‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’æˆ»ã™
                    if (lastCheckedBtn && lastCheckedBtn !== btn) {
                        lastCheckedBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
                        lastCheckedBtn.title = "ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼";
                    }
                    // ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã«å¤‰æ›´
                    btn.innerHTML = '<i class="bi bi-check"></i>';
                    btn.title = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼";
                    lastCheckedBtn = btn;
                });
            });

            resultsEl.prepend(item);
        }

        function escapeHtml(s) {
            return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger alert-dismissible fade show mt-2';
            errorDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.row'));

            // 10ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 10000);
        }

        function handleCameraError(error) {
            let message = 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';

            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                message = `
                    <strong>ã‚«ãƒ¡ãƒ©æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™</strong><br>
                    <small>
                    â€¢ ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦å´ã®ã‚«ãƒ¡ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨±å¯ã—ã¦ãã ã•ã„<br>
                    â€¢ Chrome: è¨­å®š â†’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ â†’ ã‚µã‚¤ãƒˆã®è¨­å®š â†’ ã‚«ãƒ¡ãƒ©<br>
                    â€¢ Edge: è¨­å®š â†’ ã‚µã‚¤ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ â†’ ã‚«ãƒ¡ãƒ©<br>
                    â€¢ Firefox: ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦å´ã®ç›¾ã‚¢ã‚¤ã‚³ãƒ³ â†’ æ¨©é™<br>
                    â€¢ Safari: ç’°å¢ƒè¨­å®š â†’ Webã‚µã‚¤ãƒˆ â†’ ã‚«ãƒ¡ãƒ©
                    </small>
                `;
            } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                message = 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            } else if (error.name === 'NotSupportedError') {
                message = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯ã‚µã‚¤ãƒˆã§ã¯ã‚«ãƒ¡ãƒ©ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚HTTPSã‚µã‚¤ãƒˆã¾ãŸã¯localhostã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
            } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                message = 'ã‚«ãƒ¡ãƒ©ãŒä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚';
            } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                message = 'è¦æ±‚ã•ã‚ŒãŸã‚«ãƒ¡ãƒ©è¨­å®šãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
            }

            showError(message);
        }

        cameraSelect.addEventListener('change', async () => {
            const id = cameraSelect.value;
            if (!id) return;
            await startCamera(false, id);
        });

        switchBtn.addEventListener('click', async () => {
            await startCamera(true, null);
        });

        toggleBtn.addEventListener('click', () => {
            if (scanning) {
                stopCamera();
            } else {
                startCamera(true, null);
            }
        });

        clearBtn.addEventListener('click', () => {
            resultsEl.innerHTML = '';
        });

        (async () => {
            // ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒã‚§ãƒƒã‚¯
            if (location.protocol !== 'https:' && !location.hostname.includes('localhost') && location.hostname !== '127.0.0.1') {
                document.getElementById('protocolWarning').style.display = 'inline';
            }

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ã®Chrome/Edge/Firefox/Safariã‚’ãŠä½¿ã„ãã ã•ã„ã€‚');
                return;
            }

            await enumerateCameras();
            // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«è‡ªå‹•ã§ã‚«ãƒ¡ãƒ©èµ·å‹•
            await startCamera(true, null);

            window.addEventListener('resize', () => {
                if (video && video.readyState >= 2) resizeCanvases();
            });
        })();
    </script>
    <!-- admax -->
    <script src="https://adm.shinobi.jp/s/d86aa02412ab954d11c751fe4cc28818"></script>
    <!-- admax -->
</body>


</html>
